<!DOCTYPE html>
<html lang="es">
<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<title>Panel de Administración</title>
	<link rel="stylesheet" href="{{ url_for('static', filename='Styles.css') }}">
</head>
<body>
	<div class="barra-superior">
		<div class="menu-icono" onclick="window.location='{{ url_for('index') }}'">⟵</div>
		Panel de Administración
		<div style="margin-left:auto; padding-right:16px;">
			<a href="{{ url_for('logout') }}">Cerrar sesión</a>
		</div>
	</div>

	<div class="container" style="padding-top: 100px;">
		{% with messages = get_flashed_messages(with_categories=true) %}
			{% if messages %}
				<div class="flash-messages">
					{% for category, message in messages %}
						<div class="flash-message flash-{{ category }}">{{ message }}</div>
					{% endfor %}
				</div>
			{% endif %}
		{% endwith %}

		<!-- Panel de Control -->
		<div class="dashboard-panel">
			<h2 style="margin-bottom: 20px;">Panel de Control</h2>
			<div class="stats-grid">
				<div class="stat-card">
					<div class="stat-icon">📦</div>
					<div class="stat-info">
						<div class="stat-value">{{ stats.get('total_productos', 0) }}</div>
						<div class="stat-label">Total de Productos</div>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon">⏳</div>
					<div class="stat-info">
						<div class="stat-value">{{ stats.get('pedidos_pendientes', 0) }}</div>
						<div class="stat-label">Pedidos Pendientes</div>
					</div>
				</div>
				<div class="stat-card">
					<div class="stat-icon">📊</div>
					<div class="stat-info">
						<div class="stat-value">{{ stats.get('total_pedidos', 0) }}</div>
						<div class="stat-label">Total Pedidos</div>
					</div>
				</div>
			</div>
		</div>

		<!-- Sección de categorías removida según requerimiento -->

		<h2>Gestionar Productos</h2>
		<div class="admin-section">
			<form method="POST" action="{{ url_for('admin_productos_crear') }}" class="admin-form">
				<input type="text" name="nombre" placeholder="Nombre del producto" required>
				<select name="categoria" required style="padding: 10px; border-radius: 5px; border: 1px solid #ddd;">
					<option value="">Seleccionar categoría</option>
					<option value="desayunos">Desayunos</option>
					<option value="almuerzos">Almuerzos</option>
					<option value="cenas">Cenas</option>
					<option value="meriendas">Meriendas</option>
					<option value="postres">Postres</option>
					<option value="bebidas">Bebidas</option>
					<option value="promociones">Promociones</option>
				</select>
				<input type="text" name="imagen" id="imagen-crear" placeholder="URL de imagen o enlace de Google Drive" required>
				<small style="color: #666; font-size: 12px; display: block; margin-top: 5px;">
					💡 Puedes pegar un enlace de Google Drive y se convertirá automáticamente
				</small>
				<input type="number" name="precio" placeholder="Precio" step="0.01" required>
				<textarea name="descripcion" placeholder="Ingredientes y descripción" style="padding: 10px; border-radius: 5px; border: 1px solid #ddd; min-height: 80px;"></textarea>
				<button type="submit">Agregar producto</button>
			</form>
			<table class="admin-table">
				<thead>
					<tr><th>ID</th><th>Nombre</th><th>Categoría</th><th>Imagen</th><th>Precio</th><th>Acciones</th></tr>
				</thead>
				<tbody>
					{% for p in productos %}
					<tr>
						<td>{{ p[0] }}</td>
						<td>
						<form method="POST" action="{{ url_for('admin_productos_actualizar', producto_id=p[0]) }}" class="inline-form">
								<input type="text" name="nombre" value="{{ p[1] }}" required>
								<select name="categoria" required style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
									<option value="desayunos" {% if p[3] == 'desayunos' %}selected{% endif %}>Desayunos</option>
									<option value="almuerzos" {% if p[3] == 'almuerzos' %}selected{% endif %}>Almuerzos</option>
									<option value="cenas" {% if p[3] == 'cenas' %}selected{% endif %}>Cenas</option>
									<option value="meriendas" {% if p[3] == 'meriendas' %}selected{% endif %}>Meriendas</option>
									<option value="postres" {% if p[3] == 'postres' %}selected{% endif %}>Postres</option>
									<option value="bebidas" {% if p[3] == 'bebidas' %}selected{% endif %}>Bebidas</option>
									<option value="promociones" {% if p[3] == 'promociones' %}selected{% endif %}>Promociones</option>
								</select>
								<input type="text" name="imagen" class="imagen-editar" value="{{ p[4] or '' }}" required>
								<input type="number" name="precio" value="{{ '%.2f' % p[2] }}" step="0.01" required>
								<textarea name="descripcion" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd; min-height: 60px;">{{ p[5] or '' }}</textarea>
								<button type="submit">Guardar</button>
							</form>
						</td>
						<td>
							<form method="POST" action="{{ url_for('admin_productos_eliminar', producto_id=p[0]) }}" onsubmit="return confirm('¿Eliminar producto?')">
								<button type="submit" class="btn-danger">Eliminar</button>
							</form>
						</td>
					</tr>
					{% endfor %}
				</tbody>
			</table>
		</div>

	</div>

	<script>
		// Función para convertir enlaces de Google Drive al formato de visualización directa
		function convertGoogleDriveLink(url) {
			// Patrón para detectar enlaces de Google Drive
			// Ejemplos: 
			// https://drive.google.com/file/d/FILE_ID/view?usp=sharing
			// https://drive.google.com/open?id=FILE_ID
			// https://drive.google.com/file/d/FILE_ID/edit?usp=sharing
			
			const patterns = [
				/drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/,  // Formato estándar
				/drive\.google\.com\/open\?id=([a-zA-Z0-9_-]+)/,  // Formato alternativo
				/drive\.google\.com\/uc\?id=([a-zA-Z0-9_-]+)/,    // Ya en formato directo
			];
			
			// Intentar extraer el ID del archivo
			for (let pattern of patterns) {
				const match = url.match(pattern);
				if (match && match[1]) {
					// Convertir al formato de visualización directa
					return `https://drive.google.com/uc?export=view&id=${match[1]}`;
				}
			}
			
			// Si no es un enlace de Drive, devolver el original
			return url;
		}
		
		// Función para procesar cuando se pega texto
		function handlePaste(event) {
			const input = event.target;
			setTimeout(() => {
				const value = input.value;
				if (value && value.includes('drive.google.com')) {
					const converted = convertGoogleDriveLink(value);
					if (converted !== value) {
						input.value = converted;
						// Mostrar indicador visual
						input.style.border = '2px solid #00b894';
						setTimeout(() => {
							input.style.border = '1px solid #ddd';
						}, 2000);
					}
				}
			}, 10);
		}
		
		// Función para procesar cuando se cambia el valor manualmente
		function handleInput(event) {
			const input = event.target;
			const value = input.value;
			if (value && value.includes('drive.google.com') && !value.includes('uc?export=view')) {
				// Solo convertir si no está ya en el formato correcto
				const converted = convertGoogleDriveLink(value);
				if (converted !== value) {
					input.value = converted;
					input.style.border = '2px solid #00b894';
					setTimeout(() => {
						input.style.border = '1px solid #ddd';
					}, 2000);
				}
			}
		}
		
		// Agregar event listeners cuando la página cargue
		document.addEventListener('DOMContentLoaded', function() {
			// Para el formulario de creación
			const imagenCrear = document.getElementById('imagen-crear');
			if (imagenCrear) {
				imagenCrear.addEventListener('paste', handlePaste);
				imagenCrear.addEventListener('blur', handleInput);
			}
			
			// Para los formularios de edición
			const imagenesEditar = document.querySelectorAll('.imagen-editar');
			imagenesEditar.forEach(input => {
				input.addEventListener('paste', handlePaste);
				input.addEventListener('blur', handleInput);
			});
		});
	</script>
</body>
</html>
